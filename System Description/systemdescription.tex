\documentclass[english]{article}

\usepackage{babel}
\usepackage{graphicx}
\usepackage{alltt}
\usepackage{url}
\usepackage{tabularx}
%\usepackage{ngerman}
\usepackage{longtable}
\usepackage{color}
\usepackage{framed}
\usepackage{array}

\usepackage{xifthen}
\newboolean{showbackdoors}
\setboolean{showbackdoors}{true}  % set to false to hide subsection on backdoors for reviewing group


\newenvironment{prettytablex}[1]{\vspace{0.3cm}\noindent\tabularx{\linewidth}{@{\hspace{\parindent}}#1@{}}}{\endtabularx\vspace{0.3cm}}
%\newenvironment{prettytable}{\prettytablex{l X}}{\endprettytablex}

\newcolumntype{L}{lp{0.3\textwidth}p{0.3\textwidth}p{15pt}p{15pt}p{15pt}}

\title{\huge\sffamily\bfseries System Description and Risk Analysis}
\author{B\"ahler Alessio \and Enz Andreas \and Niederberger Matthias}
\date{\today}


\begin{document}
\maketitle

%% **** please observe the page limit **** 
%% (it is not allowed to change the font size or page geometry to gain more space)
%% comment or remove lines below before hand-in
\begin{center}
{\large\textcolor{red}{Page limit: 30 pages.}}
\end{center}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\tableofcontents
\pagebreak

\begin{framed}
\noindent
{\it
Recall the following guidelines when writing your reports:
\begin{itemize}
\item Adhere to the given templates.

\item Refer to the security principles in the book for justification.

\item Use clear terminology: 
\begin{itemize}
\item secure = confidential + authentic. Be clear about
which properties you are writing.
\item Are pairwise distinct: certificate, private key, public key, archive to of certificate with private key. Please avoid mixing these up.
\end{itemize}

\item Refer to the source document of your risk definitions if appropriate.

\item For the risk evaluation, formulate the threats in active, not passive, 
voice: who (threat source) does what (threat action)? 

\item Use a spell checker before hand-in!

\end{itemize}
}
\end{framed}


\section{System Characterization}

\subsection{System Overview}

%%% Describe the systems mission,  the system boundaries,
%%% and the overall system architecture, including the main subsystems and
%%% their relationships.   This description should provide a high-level
%%% overview of the system, e.g., suitable for managers, that complements
%%% the more technical description that follows.


iMovies is a company producing independent movies with a focus on investigative reporting. This requires that information within the company and with informants is handled confidentially. Therefore email communication should be secure. 
The system described in this report implements a certificate authority (CA), that allows employees to download digital certificates created by iMovies. Those can then be used to secure their mail correspondence. 

The CA System is reachable from the internet so employees can access it from anywhere and certificates can be managed through a web interface. A network firewall serves as a first layer of defense for the iMovies company networks. The company networks are further divided into the DMZ and the internal network. The DMZ contains only the web server that hosts the CA web application. In the internal network we have a server creating and managing certificates (for short: core\_ca), a dedicated database server and a backup machine. See Fig. (?? REF OVERVIEW). 

Web traffic is handled on the web server, which in turn gets user data and certificates from the database and core\_ca server through a REST API. The backup machine periodically pulls a backup from from firewall, web server, database and core\_ca server. All traffic on the network is encrypted.



\begin{figure}[htb!]
\centering{\includegraphics[width=\textwidth]{res/system_arch.eps}}
\caption{System Architecture of the company network including an external client machine.}
\centering
\label{fig:system_arch}
\end{figure}


\subsection{System Functionality}

Describe the system's functions.


\subsection{Security Design}

Describe the system's security design, including access control, key and session management,  and security of data at rest and in transit.


\subsection{Components}

%%% List all system components and their interfaces, subdivided, for example, into
%%%   categories such as platforms, applications, data records, etc. For
%%%   each component, state its relevant properties.


\subsubsection{Backup Machine}

The backup machine pulls files from other machines using rsync 3.0.9 in archive mode over an ssh connection. We do full (non-incremental) backups at scheduled intervals of important system logs, applications logs, application configuration and data. Backed up machines are:

\begin{itemize}
    \item web server
    \item firewall
    \item core ca
    \item database
\end{itemize}

Not only the last backup is stored, we keep old backups. But to reduce the amount of data stored a cleanup process deletes backups after they reach a certain age. Files can be restored using rsync and reversing source and target of the backup command. 
While the data in transit is encrypted through the use of ssh, backups on the machine are not encrypted. The machine can only be accessed physically and over ssh with the private key of the sysadmin.

Scheduling of pulling and cleaning the backups is done with cron. There are two main backup frequencies. The first one is a daily pull of seldom changing, less important files. The second one pulls every 20 minutes. Jobs are staggered so that they don't start at the same time. To be able to automate this process over ssh a passwordless private key is needed for the backup user and all machines listed above need to authorize the corresponding public key.
The files and folders that need to be pulled have to be listed in configuration files on the backup machine. In general, the pull approach allows central administration of the whole backup process on a single machine.




\subsubsection{Network Firewall Machine}
- pfsense shell interface
- webinterface for pfsense
- interfaces: inet, dmz, internal, webinterface

This machine separates the iMovies company networks from the internet and serves as a first line of defense. Furthermore it serves as a router, mainly for incoming webtraffic and ssh connections. We use pfsense 2.4.1 installed on FreeBSD 64-bit. Administration of pfSense is mostly done over a web interface, which is only reachable from the internal network. But remote administration of the web interface is possible by first creating an ssh tunnel to the internal network interface and then starting a web session over this tunnel (using for example Firefox with a SOCKS proxy) 

As seen in Fig. (?? REF OVERVIEW) the Firewall has three network interfaces connecting to the internet, DMZ and internal network. In the following we describe the routing (NAT) and firewall rules set up on each interface. All rules we set up do explicitly allow certain traffic, because the pfSense default is to reject everything. 

We use static IPs on all machines and network interfaces (see Figure ??? REF TOPO). For the sake of readability we will use the following names for the IP addresses:

\begin{table}[h]
\centering
\begin{tabular}{|l|l|l|}
\hline
\textbf{Name} & \textbf{IP} & \textbf{Description} \\ \hline
WAN & 192.168.70.10 & Firewall interface connecting to the internet \\ \hline
DMZ & 192.168.51.51 & Firewall interface connecting to the DMZ \\ \hline
INTERN & 192.168.50.50 & Firewall interface connecting to the internal network \\ \hline
WS & 192.168.51.14 & Web server \\ \hline
DB & 192.168.50.33 & Database server \\ \hline
BK & 192.168.50.32 & Backup machine \\ \hline
CA & 192.168.50.31 & Core CA server \\ \hline

\end{tabular}
\caption{Names of IPs used in further explanations. See Figure ??? REF OVERVIEW for a graphical representation}
\label{fw_ip_names}
\end{table}


\textbf{WAN port routing table}

The only IP exposed to the internet is that of the WAN interface. This means traffic has to be routed to the correct machine using NAT. The only traffic from the internet we we want to allow is https traffic to the web server and ssh traffic to every machine for remote administration. Table \ref{fw_inet_nat} shows the routing rules for TCP traffic depending on destination port.

\begin{table}[h]
\centering
\begin{tabular}{|c||c|c|}
\hline
\textbf{Dest. Port} & \textbf{NAT IP} & \textbf{NAT Port} \\ \hline
443 & WS & 8100 \\ \hline
5050 & INTERN & 22 \\ \hline
5031 & CA & 22 \\ \hline
5032 & BK & 22 \\ \hline
5033 & DB & 22 \\ \hline
5114 & WS & 22 \\ \hline

\end{tabular}
\caption{NAT port routing at the WAN interface}
\label{fw_inet_nat}
\end{table}


pfSense automatically creates firewall rules to allow NATed traffic. The only rule we add is to allow ICMP traffic to the WAN interface from any host, so that the ping command can be used to check if the WAN interface is reachable.



\textbf{DMZ firewall rules}

Only connections from the web server to the https ports of database and core\_ca are allowed. Also enabling ICMP to be able to ping any host on the company network.

\begin{table}[h]
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
\textbf{Protocol} & \textbf{Src. IP} & \textbf{Dest. IP} & \textbf{Dest. Port} & \textbf{Action} \\ \hline
TCP & WS & DB & 8100 & Pass\\ \hline
TCP & WS & CA & 8100 & Pass \\ \hline
ICMP & * & * & * & Pass \\ \hline

\end{tabular}
\caption{Firewall rules at the DMZ interface}
\label{fw_dmz}
\end{table}



\textbf{INTERN firewall rules}




\ifthenelse{\boolean{showbackdoors}}{
% show for handed-in version

\subsection{Backdoors}

\subsubsection{Easy Backdoor}
We put the easy backdoor on the Backup machine. In certain intervals a port is opened for a short time that is directly bound to a shell. Once the attacker has access to the Backup machine he can ssh as root into all other machines from which backup data is pulled. This is possible because the backup process has root access over ssh to all machines that need to be backed up, since it needs to pull system logs readable only by root.

We did this with netcat listening on port 9844 for 10 seconds:
ncat -l 9844 -i 10 -v -e /bin/bash
The interval scheduling is done with a few cronjobs in the crontab of user backup. To obscure those crontab entries, all their output to stdout and stderr is sent to /dev/null. Also the crontab calls a bash script instead of the netcat command, so that is looks a bit less suspicious. Finally that script is hidden with with a not so easy to find name ". ", which makes it more suspicous in the crontab entry but harder to find in general.
The port opens in a pattern every few minutes. The pattern repeats every 10 minutes and during those opens at minute 0, 1, 3, 5, 6, 8.

The connection is persistent if an attacker connects curing those 10 seconds when the port is open.


\bigskip\noindent
\textbf{Hide this subsection in the version handed over to the reviewing team by setting the flag \texttt{showbackdoors} at the top of this document to \texttt{false}.}


%% do not delete the three lines below
}{ 
% empty for reviewing group's version
} 

\subsection{Additional Material}

You may have additional sections according to your needs.


\section{Risk Analysis and Security Measures}

\subsection{Assets}

%% TODO: Describe the relevant assets and their required security
%%  properties. For example, data objects, access restrictions,
%%  configurations, etc.

\textbf{Physical Assets}
\begin{itemize}
\item Web Server: physical machine hosting the Web Server Application. Must be available and enable secure and tamper resistant communications with the clients.
\item Core CA: physical machine hosting the CA application and the legacy database.
\item Backup: physical machine hosting the backup data.
\item Internet Connectivity: Modem and lines connecting the WebServer to the Internet.
\item Internal Network: LAN via physical lines and a switching modem.
\end{itemize}

\noindent\textbf{Logical Assets}
\begin{itemize}
    \item Software
    \begin{itemize}
    \item Web Server Application
        \item Core CA Application
        \item Legacy MySQL database/application/driver?
        \item REST API
        \item Backup Daemon
        \item Backup Manager
        \item Firewall
    \end{itemize}
    \item Information
    \begin{itemize}
        \item Certificates
        \item Keys
        \item User data
        \item Configuration files
        \item Logs
    \end{itemize}
\end{itemize}


\noindent\textbf{Persons}
\begin{itemize}
\item System Administrator: maintains the system by applying software updates, controlling system logs to search malicious behaviours that could lead to security issues and ensuring that the machines hosting the systems components are working properly. He therefore has access to sensitive data, in the form of a remote connection well as physical access to all components.
\item CA Administrators: are able to verify the current state of the CA.
\item Users: Employees and Informants that both use the system to obtain certificates which allow them to communicate securely with the WebServer.
\item Management
\end{itemize}

\noindent\textbf{Intangible Goods}
\begin{itemize}
\item Company Reputation
\item Confidentiality of informant identities.
\end{itemize}

\subsection{Threat Sources}

% TODO: Name and describe potential threat sources (\emph{not} threats!) including their motivation.

\begin{itemize}
\item Nature: Floods, lightning strikes, earthquakes can damage the physical infrastructure.
\item Users: Employees (includes also cleaning personnel etc.) and informants can act maliciously or be careless/poorly trained.
\item Competitors: may be interested in obtaining confidential information to gain an advantage, blackmail or cause harm by publishing it. May resort to Skilled Hackers to achieve their goals.
\item "Victims": subjects of investigative reports that were publicly exposed and may want to get revenge by causing any kind of damage. May resort to Skilled Hackers to achieve their goals.
\item Organized Crime: can directly or indirectly be "Victim", could be interested in blackmailing the Company to gain money or just to obtain important information that can be sold on the black market/used for other illegal activities.
\item Malware: may be non-directional or self-spreading and have different goals, e.g. Ransomware, Trojans.
\item Expert Hackers: A skilled hacker has expert knowledge for some systems. He can write his own code and may use unknown or unpublished vulnerabilities (from book). May itself be a "Victim" or act for monetary interests.
\item Script Kiddies: This type of adversary has basic computer knowledge and uses mainly known vulnerabilities for which exploits are available on the Internet. However, he might write scripts to automate tasks or use tools to automatically create malware. His main motivations are challenge, glory and destruction (from book).
\item Organizatorial Deficiencies: lack in employee training, poor/non-existing/non-enforced security measures, such as unsanitized user input, can weaken the overall security of the system.
\item Hardware Failures
\end{itemize}

\subsection{Risks Definitions}

Definition of Likelihood, Impact and Risk level using the following three
  tables from \cite{ASL_book}.

%\subsubsection{Tools}

\begin{center}
\begin{tabular}{|l|p{0.8\textwidth}|}
\hline
%\multicolumn{2}{|c|}{\bf Likelihood} \\
%\hline
Likelihood & Description \\
\hline
\hline
High   & The threat source is highly motivated and sufficiently capable of exploiting a given vulnerability in order to change the asset's state. The controls to prevent the vulnerability from being exploited are ineffective. \\
\hline
Medium & The threat source is motivated and capable of exploiting a given vulnerability in order to change the asset's state, but controls are in place that may impede a successful exploit of the vulnerability. \\
\hline
Low   & The threat source lacks motivation or capabilities to exploit a given vulnerability in order to change the asset's state. Another possibility that results in a low likelihood is the case where controls are in place that prevent (or at least significantly impede) the vulnerability from being exercised. \\
\hline
\end{tabular}
\hspace{3em}
\begin{tabular}{|l|p{0.8\textwidth}|}
\hline
\multicolumn{2}{|c|}{\bf Impact} \\
\hline
Impact & Description \\
\hline
\hline
High   & The event (1) may result in a highly costly loss of major tangible assets or resources; (2) may significantly violate, harm, or impede an organization's mission, reputation, or interest; or (3) may result in human death or serious injury. \\
\hline
Medium & The event (1) may result in a costly loss of tangible assets or resources; (2) may violate, harm, or impede an organization's mission, reputation, or interest, or (3) may result in human injury. \\
\hline
Low   & The event (1) may result in a loss of some tangible assets or resources or (2) may noticeably affect an organization's mission, reputation, or inter- est. \\
\hline
\end{tabular}
\end{center}

\vspace{5mm}

\begin{center}
\begin{tabular}{|l|c|c|c|}
\hline
\multicolumn{4}{|c|}{{\bf Risk Level}} \\
\hline
{{\bf Likelihood}} & \multicolumn{3}{c|}{{\bf Impact}} \\ %\cline{2-4}
     & Low & Med & High \\  \hline
 High & Low & Med & High  \\
\hline
 Med & Low & Med & Med \\
\hline
 Low & Low & Low & Low \\
\hline
\end{tabular}
\end{center}



\subsection{Risk Evaluation}

% List all potential threats and the corresponding countermeasures. Estimate the risk based on the information about the threat, the threat sources and the corresponding countermeasure. Adhere to the risk definitions you have given above. As a sanity check, there should be at least one high-risk entry.

Potential threats and countermeasures with the inferred risk.


\subsubsection{{\it Evaluation Web Server}}

\begin{footnotesize}
\begin{prettytablex}{L}
No. & Threat &  Countermeasure(s) & L & I & Risk \\
\hline
1 & Expert Hackers: mount MitM attack to spy on and tamper with communications between Clients and WebServer. This allows the hackers to learn in particular a user's password and private keys. & HTTPs connection with Server side authentication & {\it Med} & {\it High} & {\it Med} \\
\hline
2 & Victim: resorts to Script Kiddies to launch DDoS attack on WebServer and cause damage, disruptions, maybe even ask money to stop & Simple DDoS protection like SYN cookies against syn flood & {\it High} & {\it High} & {\it High} \\
\hline
\end{prettytablex}
\end{footnotesize}

\subsubsection{{\it Evaluation Core CA}}

\begin{footnotesize}
\begin{prettytablex}{L}
No. & Threat &  Countermeasure(s) & L & I & Risk \\
\hline
1 & Hardware Failures: cause damages to the hard drives and privite CA key and certificate can't be recovered. &  & {\it Low} & {\it Med} & {\it Low} \\
\hline
\end{prettytablex}
\end{footnotesize}

\subsubsection{{\it Evaluation Backup}}

\begin{footnotesize}
\begin{prettytablex}{L}
No. & Threat &  Countermeasure(s) & L & I & Risk \\
\hline
1 & User: exploits physical access to Backup Machine and obtains backup data. & Physical protection of System Components, Disk Encryption & {\it Low} & {\it Med} & {\it Low} \\
\hline
\end{prettytablex}
\end{footnotesize}

\subsubsection{{\it Evaluation System Administrator}}

\begin{footnotesize}
\begin{prettytablex}{L}
No. & Threat &  Countermeasure(s) & L & I & Risk \\
\hline
1 & Expert Hacker: steals System Administrator credentials & Enforce Strong Passwords, Increase security sensibilization/awareness & {\it Med} & {\it High} & {\it Med} \\
\hline
2 & Organizatorial Deficiencies: illness or injury impede its work and the System is left unattended in case of problems/attacks & Good Documentation and making sure that not only one person knows the system & {\it High} & {\it Med} & {\it Med} \\
\hline
\end{prettytablex}
\end{footnotesize}

\begin{thebibliography}{---}
\bibitem[1]{CompSec} Computer Security: Principles and Practice. William Stallings and Laurie Brown, Prentice Hall, 2008
\bibitem[2]{ASL_book} Applied Information Security: A Hands-on Approach, David Basin, Patrick Schaller and Michael Schlï¿½pfer, Springer, 2011
\end{thebibliography}

\end{document}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "../../book"
%%% End: 
